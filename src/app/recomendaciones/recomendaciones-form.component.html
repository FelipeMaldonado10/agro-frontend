<div class="container-fluid p-3">
  <div class="card">
    <div class="card-header">
      <h4><i class="fas fa-seedling"></i> Recomendaciones de Cultivo</h4>
    </div>
    <div class="card-body">
      <div *ngIf="parcelas.length === 0" class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        No tienes parcelas registradas. <a routerLink="/parcelas" class="btn btn-sm btn-primary ms-2">Registrar Parcela</a>
      </div>

      <div *ngIf="parcelas.length > 0">
        <form [formGroup]="form" class="mb-4">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Fecha planeada de siembra:</label>
              <input formControlName="fechaSiembra" type="date" class="form-control" />
              <small class="form-text text-muted">Esta fecha se usa para evaluar la temporada y precios esperados</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Parcela espec√≠fica (opcional):</label>
              <select formControlName="parcela" class="form-control">
                <option value="">Todas las parcelas</option>
                <option *ngFor="let parcela of parcelas" [value]="parcela._id">
                  {{ parcela.nombre }} - {{ parcela.ciudad?.nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <button class="btn btn-success me-2" type="button" (click)="consultarTodas()" [disabled]="cargando">
              <i class="fas fa-chart-line" *ngIf="!cargando"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="cargando"></i>
              {{ cargando ? 'Consultando...' : 'Obtener Recomendaciones' }}
            </button>
            
            <button class="btn btn-primary" type="button" (click)="consultarParcela()" 
                    [disabled]="!form.get('parcela')?.value || cargando">
              <i class="fas fa-map-marker-alt"></i>
              Consultar Parcela Espec√≠fica
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Resultados -->
  <div *ngIf="resultado" class="mt-4">
    <div class="alert alert-success">
      <strong><i class="fas fa-check-circle"></i> Recomendaciones generadas exitosamente</strong><br>
      <small>Fecha: {{ formatearFecha(resultado.fecha_siembra) }} | 
             Parcelas evaluadas: {{ resultado.total_parcelas }}</small>
    </div>
    
    <div *ngFor="let recomendacion of resultado.recomendaciones" class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-map-marker-alt"></i> 
          {{ recomendacion.parcela.nombre }} - {{ recomendacion.parcela.ciudad }}
        </h5>
        <small>
          Coordenadas: {{ recomendacion.parcela.coordenadas?.latitud }}, {{ recomendacion.parcela.coordenadas?.longitud }}
        </small>
      </div>
      
      <div class="card-body">
        <!-- Estado de datos -->
        <div *ngIf="recomendacion.estado_datos" class="row mb-3">
          <div class="col-md-12">
            <div class="alert alert-info">
              <strong>Estado de la informaci√≥n:</strong><br>
              ‚Ä¢ Productos evaluados: {{ recomendacion.estado_datos.total_productos_evaluados }}<br>
              ‚Ä¢ Con precios hist√≥ricos: {{ recomendacion.estado_datos.productos_con_precios }}<br>
              ‚Ä¢ Sin precios: {{ recomendacion.estado_datos.productos_sin_precios }}<br>
              ‚Ä¢ Datos clim√°ticos: {{ recomendacion.estado_datos.datos_climaticos_disponibles ? 'Disponibles' : 'No disponibles' }}
            </div>
          </div>
        </div>

        <!-- Alertas generales -->
        <div *ngIf="recomendacion.alertas_generales?.length" class="alert alert-warning">
          <strong>‚ö†Ô∏è Consideraciones importantes:</strong>
          <ul class="mb-0 mt-1">
            <li *ngFor="let alerta of recomendacion.alertas_generales">{{ alerta }}</li>
          </ul>
        </div>

        <!-- Mejores opciones -->
        <h6 class="text-success">üå± Top 3 Recomendaciones:</h6>
        <div class="row">
          <div *ngFor="let opcion of recomendacion.mejores_opciones; index as i" class="col-md-4 mb-3">
            <div class="card h-100" [class]="i === 0 ? 'border-success' : (i === 1 ? 'border-warning' : 'border-info')">
              <div class="card-header" [class]="i === 0 ? 'bg-success text-white' : (i === 1 ? 'bg-warning text-dark' : 'bg-info text-white')">
                <h6 class="mb-0">
                  {{ i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : 'ü•â') }} {{ opcion.producto }}
                  <span class="badge bg-light text-dark float-end">{{ opcion.score }} pts</span>
                </h6>
              </div>
              <div class="card-body">
                <div class="mb-2">
                  <strong>üí∞ Precio promedio:</strong> ${{ opcion.promedio_precio | number:'1.0-0' }}
                </div>
                <div class="mb-2">
                  <strong>üìà Tendencia:</strong> 
                  <span [class]="opcion.tendencia_precio > 0 ? 'text-success' : (opcion.tendencia_precio < 0 ? 'text-danger' : 'text-muted')">
                    {{ opcion.tendencia_precio > 0 ? '‚ÜóÔ∏è +' : (opcion.tendencia_precio < 0 ? '‚ÜòÔ∏è ' : '‚û°Ô∏è ') }}${{ Math.abs(opcion.tendencia_precio) | number:'1.0-0' }}
                  </span>
                </div>
                <div class="mb-2">
                  <strong>‚è±Ô∏è Cosecha:</strong> {{ opcion.tiempo_cosecha }} d√≠as
                </div>
                <div class="mb-2">
                  <strong>üìÖ Fecha estimada:</strong> {{ formatearFecha(opcion.fecha_estimada_cosecha) }}
                </div>
                <div class="mb-2">
                  <strong>üå§Ô∏è Temporada:</strong> {{ opcion.temporada || 'Todo el a√±o' }}
                </div>

                <!-- Datos clim√°ticos -->
                <div *ngIf="opcion.datos_climaticos" class="mt-2 small">
                  <strong>üå°Ô∏è Condiciones clim√°ticas:</strong><br>
                  ‚Ä¢ Temperatura: {{ opcion.datos_climaticos.temperatura_actual }}¬∞C 
                  (√≥ptimo: {{ opcion.datos_climaticos.temperatura_optima }}¬∞C)<br>
                  ‚Ä¢ Humedad: {{ opcion.datos_climaticos.humedad_actual }}% 
                  (√≥ptimo: {{ opcion.datos_climaticos.humedad_optima }}%)
                </div>

                <!-- Evaluaci√≥n detallada -->
                <div *ngIf="opcion.detalles_evaluacion?.length" class="mt-2">
                  <strong class="text-success">‚úÖ Factores favorables:</strong>
                  <ul class="small mb-1">
                    <li *ngFor="let detalle of opcion.detalles_evaluacion" class="text-success">{{ detalle }}</li>
                  </ul>
                </div>

                <!-- Alertas espec√≠ficas -->
                <div *ngIf="opcion.alertas?.length" class="mt-2">
                  <strong class="text-warning">‚ö†Ô∏è Consideraciones:</strong>
                  <ul class="small mb-1">
                    <li *ngFor="let alerta of opcion.alertas" class="text-warning">{{ alerta }}</li>
                  </ul>
                </div>

                <!-- Observaciones -->
                <div *ngIf="opcion.observaciones" class="mt-2 small text-muted">
                  <strong>üí° Observaciones:</strong> {{ opcion.observaciones }}
                </div>

                <!-- Bot√≥n para sembrar -->
                <div class="mt-3">
                  <button 
                    class="btn btn-sm w-100"
                    [class]="i === 0 ? 'btn-success' : (i === 1 ? 'btn-warning' : 'btn-info')"
                    (click)="sembrarProducto(opcion, recomendacion.parcela)">
                    üå± Sembrar este producto
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bot√≥n para ver todos los productos -->
        <div class="mt-3 text-center">
          <button 
            class="btn btn-outline-primary"
            (click)="verTodosLosProductos(recomendacion.parcela)">
            üìã Ver todos los productos disponibles
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para crear cultivo -->
  <div *ngIf="mostrarModalCultivo" class="modal d-block" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            üå± Sembrar {{ productoSeleccionado?.producto }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
        </div>
        
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <strong>Parcela:</strong> {{ parcelaSeleccionada?.nombre }}
            </div>
            <div class="col-md-6">
              <strong>Ciudad:</strong> {{ parcelaSeleccionada?.ciudad }}
            </div>
          </div>

          <div class="alert alert-info">
            <strong>Score de recomendaci√≥n:</strong> {{ productoSeleccionado?.score }}/10 - 
            Posici√≥n #{{ productoSeleccionado?.posicion_ranking }}
          </div>

          <form [formGroup]="formCultivo">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Cantidad a sembrar *</label>
                <input 
                  type="number" 
                  class="form-control" 
                  formControlName="cantidad_sembrada"
                  min="1"
                  step="1">
                <small class="text-muted">N√∫mero de plantas, semillas o unidades</small>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">√Årea de siembra *</label>
                <div class="input-group">
                  <input 
                    type="number" 
                    class="form-control" 
                    formControlName="area_sembrada"
                    min="0.1"
                    step="0.1">
                  <select class="form-select" formControlName="unidad_area" style="max-width: 100px;">
                    <option value="m2">m¬≤</option>
                    <option value="hectarea">hect√°rea</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-12">
                <label class="form-label">Fecha de siembra</label>
                <input 
                  type="date" 
                  class="form-control" 
                  formControlName="fecha_siembra">
              </div>
            </div>

            <!-- Estimaciones autom√°ticas -->
            <div class="mt-4 p-3 bg-light rounded">
              <h6>üìä Estimaciones (se calcular√°n autom√°ticamente):</h6>
              <ul class="mb-0">
                <li>Cantidad estimada de producci√≥n</li>
                <li>Ingresos proyectados</li>
                <li>Fecha estimada de cosecha</li>
                <li>Rendimiento por √°rea</li>
              </ul>
            </div>
          </form>
        </div>
        
        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="cerrarModal()"
            [disabled]="creandoCultivo">
            Cancelar
          </button>
          <button 
            type="button" 
            class="btn btn-success" 
            (click)="crearCultivo()"
            [disabled]="!formCultivo.valid || creandoCultivo">
            <span *ngIf="!creandoCultivo">üå± Crear Cultivo</span>
            <span *ngIf="creandoCultivo">
              <i class="fas fa-spinner fa-spin"></i> Creando...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensaje de error -->
  <div *ngIf="mensaje" class="alert alert-danger mt-3">
    <i class="fas fa-exclamation-circle"></i> {{ mensaje }}
  </div>
</div>
